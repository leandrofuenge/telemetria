version: "3.9"

services:

  # =========================================
  # BANCO DE DADOS MYSQL
  # =========================================
  mysql:
    image: mysql:8.4
    container_name: telemetria-mysql
    restart: always
    environment:
      MYSQL_ROOT_PASSWORD: root
      MYSQL_DATABASE: telemetria
      MYSQL_USER: telemetria
      MYSQL_PASSWORD: telemetria
    ports:
      - "3306:3306"
    volumes:
      - mysql_data:/var/lib/mysql
    networks:
      - telemetria-network
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "-h", "localhost"]
      timeout: 10s
      retries: 5

  # =========================================
  # PHPMYADMIN
  # =========================================
  phpmyadmin:
    image: phpmyadmin:latest
    container_name: telemetria-phpmyadmin
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
    ports:
      - "8081:80"
    environment:
      PMA_HOST: mysql
      PMA_PORT: 3306
      PMA_USER: root
      PMA_PASSWORD: root
    networks:
      - telemetria-network

  # =========================================
  # ZOOKEEPER
  # =========================================
  zookeeper:
    image: confluentinc/cp-zookeeper:7.5.0
    container_name: telemetria-zookeeper
    restart: always
    environment:
      ZOOKEEPER_CLIENT_PORT: 2181
      ZOOKEEPER_TICK_TIME: 2000
    ports:
      - "2181:2181"
    networks:
      - telemetria-network
    healthcheck:
      test: ["CMD", "nc", "-vz", "localhost", "2181"]
      timeout: 10s
      retries: 5

  # =========================================
  # KAFKA
  # =========================================
  kafka:
    image: confluentinc/cp-kafka:7.5.0
    container_name: telemetria-kafka
    restart: always
    depends_on:
      zookeeper:
        condition: service_healthy
    ports:
      - "9092:9092"
    environment:
      KAFKA_BROKER_ID: 1
      KAFKA_ZOOKEEPER_CONNECT: zookeeper:2181
      KAFKA_ADVERTISED_LISTENERS: PLAINTEXT://kafka:9092
      KAFKA_OFFSETS_TOPIC_REPLICATION_FACTOR: 1
      KAFKA_TRANSACTION_STATE_LOG_MIN_ISR: 1
      KAFKA_TRANSACTION_STATE_LOG_REPLICATION_FACTOR: 1
      KAFKA_CREATE_TOPICS: "telemetria-raw:3:1,telemetria-alertas:2:1,telemetria-desvios:2:1"
    networks:
      - telemetria-network
    healthcheck:
      test: ["CMD", "kafka-topics", "--bootstrap-server", "localhost:9092", "--list"]
      timeout: 10s
      retries: 5

  # =========================================
  # KAFKA UI
  # =========================================
  kafka-ui:
    image: provectuslabs/kafka-ui:latest
    container_name: telemetria-kafka-ui
    restart: always
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "8082:8080"
    environment:
      KAFKA_CLUSTERS_0_NAME: telemetria-cluster
      KAFKA_CLUSTERS_0_BOOTSTRAPSERVERS: kafka:9092
      KAFKA_CLUSTERS_0_ZOOKEEPER: zookeeper:2181
    networks:
      - telemetria-network

  # =========================================
  # EMQX
  # =========================================
  emqx:
    image: emqx:5.8
    container_name: telemetria-emqx
    restart: always
    depends_on:
      kafka:
        condition: service_healthy
    ports:
      - "1883:1883"
      - "8883:8883"
      - "8083:8083"
      - "8084:8084"
      - "18083:18083"
    environment:
      EMQX_NAME: telemetria
      EMQX_HOST: 0.0.0.0
      EMQX_DASHBOARD__DEFAULT_USERNAME: admin
      EMQX_DASHBOARD__DEFAULT_PASSWORD: admin123
      EMQX_LISTENERS__TCP__DEFAULT__BIND: 0.0.0.0:1883
      EMQX_LISTENERS__WS__DEFAULT__BIND: 0.0.0.0:8083
      EMQX_BRIDGE__KAFKA__TELEMETRIA__ENABLE: true
      EMQX_BRIDGE__KAFKA__TELEMETRIA__BOOTSTRAP_HOSTS: "kafka:9092"
      EMQX_BRIDGE__KAFKA__TELEMETRIA__TOPIC: "telemetria-raw"
      EMQX_BRIDGE__KAFKA__TELEMETRIA__PRODUCE__QOS: 1
      EMQX_PERSISTENCE__MODE: "database"
      EMQX_PERSISTENCE__DATABASE__TYPE: "mysql"
      EMQX_PERSISTENCE__DATABASE__SERVER: "mysql:3306"
      EMQX_PERSISTENCE__DATABASE__DATABASE: "emqx"
      EMQX_PERSISTENCE__DATABASE__USERNAME: "telemetria"
      EMQX_PERSISTENCE__DATABASE__PASSWORD: "telemetria"
    networks:
      - telemetria-network
    healthcheck:
      test: ["CMD", "emqx_ctl", "status"]
      timeout: 10s
      retries: 5

  # =========================================
  # APLICAÇÃO SPRING BOOT (CORRIGIDO)
  # =========================================
  app:
    build: .
    container_name: telemetria-app
    restart: always
    depends_on:
      mysql:
        condition: service_healthy
      kafka:
        condition: service_healthy
      emqx:
        condition: service_healthy
    ports:
      - "8080:8080"
    environment:
      # Banco de Dados
      SPRING_DATASOURCE_URL: jdbc:mysql://mysql:3306/telemetria?useSSL=false&allowPublicKeyRetrieval=true&serverTimezone=UTC
      SPRING_DATASOURCE_USERNAME: telemetria
      SPRING_DATASOURCE_PASSWORD: telemetria
      SPRING_JPA_HIBERNATE_DDL_AUTO: validate
      SPRING_FLYWAY_ENABLED: true
      
      # Kafka
      SPRING_KAFKA_BOOTSTRAP_SERVERS: kafka:9092
      
      # OpenWeather - CORRIGIDO: usando as chaves diretamente
      OPENWEATHER_API_KEY: ""
      OPENWEATHER_API_URL: "https://api.openweathermap.org/data/2.5/weather"
      OPENWEATHER_API_UNITS: "metric"
      OPENWEATHER_API_LANG: "pt_br"
      
      # IPLocate - CORRIGIDO: usando as chaves diretamente
      IPLOCATE_API_KEY: ""
      IPLOCATE_API_URL: "https://iplocate.io/api/lookup"
      
      # MQTT
      MQTT_BROKER_URL: tcp://emqx:1883
      MQTT_USERNAME: admin
      MQTT_PASSWORD: admin123
      
      # JWT
      JWT_SECRET: MinhaChaveSuperSeguraMuitoForte1234
      JWT_EXPIRATION: 3600000
      JWT_REFRESH_EXPIRATION: 86400000
    volumes:
      - ./logs:/app/logs
    networks:
      - telemetria-network

  # =========================================
  # MOSQUITTO (OPCIONAL)
  # =========================================
  mosquitto:
    image: eclipse-mosquitto:latest
    container_name: telemetria-mosquitto
    restart: always
    ports:
      - "1884:1883"
      - "9001:9001"
    volumes:
      - ./mosquitto/config:/mosquitto/config
      - ./mosquitto/data:/mosquitto/data
      - ./mosquitto/log:/mosquitto/log
    networks:
      - telemetria-network

networks:
  telemetria-network:
    driver: bridge

volumes:
  mysql_data:
